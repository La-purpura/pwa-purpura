generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Territory {
  id                 String             @id @default(cuid())
  name               String
  type               String
  parentId           String?
  alertTerritories   AlertTerritory[]
  reportTerritories   ReportTerritory[]
  postTerritories     PostTerritory[]
  projectTerritories ProjectTerritory[]
  resourceTerritories ResourceTerritory[]
  taskTerritories     TaskTerritory[]
  requests           Request[]
  parent             Territory?         @relation("Hierarchy", fields: [parentId], references: [id])
  children           Territory[]        @relation("Hierarchy")
  users              User[]
  userScopes         UserScope[]
}

model Branch {
  id        String     @id @default(cuid())
  name      String     @unique
  posts     Post[]
  resources Resource[]
  users     User[]
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  passwordHash      String
  name              String?
  alias             String?
  phone             String?
  photoUrl          String?
  role              String
  branchId          String?
  territoryScope    Json?
  settings          Json?    // { notifications: 'all' | 'critical' | 'none' }
  status            String       @default("ACTIVE")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  territoryId       String?
  auditLogs         AuditLog[]
  assignedReports   Report[]     @relation("AssignedReports")
  reportedReports   Report[]     @relation("ReportedReports")
  invitationsSent   Invitation[] @relation("InvitedBy")
  authoredPosts     Post[]       @relation("AuthoredPosts")
  readPosts         PostRead[]
  ledProjects       Project[]
  requests          Request[]
  authoredResources Resource[]   @relation("AuthoredResources")
  uploadedFiles     ResourceVersion[]
  sessions          Session[]
  assignedTasks     Task[]
  readAlerts        AlertRead[]
  branch            Branch?      @relation(fields: [branchId], references: [id])
  territory         Territory?   @relation(fields: [territoryId], references: [id])
  twoFactorSecret   String?
  twoFactorEnabled  Boolean      @default(false)
  scopes            UserScope[]
  notifications     Notification[]
  attachments       Attachment[] @relation("UploadedAttachments")
}

model Attachment {
  id           String    @id @default(cuid())
  fileName     String
  fileKey      String
  thumbnailKey String?
  fileSize     Int
  mimeType     String
  ownerType    String    // e.g., 'Project', 'Task', 'Report'
  ownerId      String
  territoryId  String?
  uploadedById String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  uploadedBy   User      @relation("UploadedAttachments", fields: [uploadedById], references: [id])

  @@index([ownerType, ownerId])
  @@index([territoryId])
  @@index([createdAt])
}

model UserScope {
  userId      String
  territoryId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([userId, territoryId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  data      Json?    // Para links o metadatos extra
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Session {
  id        String    @id @default(cuid())
  tokenHash String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  ipAddress String?
  userAgent String?
  lastActive DateTime @default(now())
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      String     @default("pending")
  priority    String     @default("medium")
  dueDate     DateTime?
  assigneeId  String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  territories TaskTerritory[]

  @@index([status])
  @@index([assigneeId])
  @@index([createdAt])
}

model TaskTerritory {
  taskId      String
  territoryId String
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([taskId, territoryId])
}

model Alert {
  id          String      @id @default(cuid())
  title       String
  message     String
  type        String      @default("info")
  severity    String      @default("medium")
  status      String      @default("active")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  territories AlertTerritory[]
  reads       AlertRead[]

  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

model AlertTerritory {
  alertId     String
  territoryId String
  alert       Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([alertId, territoryId])
}

model AlertRead {
  alertId String
  userId  String
  readAt  DateTime @default(now())
  alert   Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([alertId, userId])
}

model Project {
  id          String             @id @default(cuid())
  code        String?            @unique
  title       String
  status      String             @default("draft")
  priority    String             @default("medium")
  type        String?
  branch      String?
  description String?
  leaderId    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  leader      User?              @relation(fields: [leaderId], references: [id])
  kpis        ProjectKPI[]
  milestones  ProjectMilestone[]
  risks       ProjectRisk[]
  territories ProjectTerritory[]

  @@index([status])
  @@index([leaderId])
  @@index([createdAt])
}

model ProjectTerritory {
  projectId   String
  territoryId String
  project     Project   @relation(fields: [projectId], references: [id])
  territory   Territory @relation(fields: [territoryId], references: [id])

  @@id([projectId, territoryId])
}

model ProjectKPI {
  id        String  @id @default(cuid())
  projectId String
  name      String
  target    Float
  current   Float   @default(0)
  unit      String  @default("%")
  project   Project @relation(fields: [projectId], references: [id])
}

model ProjectMilestone {
  id        String    @id @default(cuid())
  projectId String
  name      String
  status    String    @default("pending")
  endDate   DateTime?
  project   Project   @relation(fields: [projectId], references: [id])
}

model ProjectRisk {
  id          String  @id @default(cuid())
  projectId   String
  description String
  probability Int
  impact      Int
  project     Project @relation(fields: [projectId], references: [id])
}

model Request {
  id            String     @id @default(cuid())
  type          String
  data          String
  status        String     @default("pending")
  feedback      String?
  submittedById String
  territoryId   String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  submittedBy   User       @relation(fields: [submittedById], references: [id])
  territory     Territory? @relation(fields: [territoryId], references: [id])
}

model Post {
  id          String     @id @default(cuid())
  title       String
  content     String
  type        String     @default("news")
  branchId    String?
  authorId    String
  isDraft     Boolean    @default(false)
  publishedAt DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  author      User       @relation("AuthoredPosts", fields: [authorId], references: [id])
  branch      Branch?    @relation(fields: [branchId], references: [id])
  territories PostTerritory[]
  reads       PostRead[]

  @@index([publishedAt])
  @@index([branchId])
  @@index([createdAt])
}

model PostTerritory {
  postId      String
  territoryId String
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([postId, territoryId])
}

model PostRead {
  postId String
  userId String
  readAt DateTime @default(now())
  post   Post     @relation(fields: [postId], references: [id])
  user   User     @relation(fields: [userId], references: [id])

  @@id([postId, userId])
  @@index([userId])
}

model Resource {
  id          String            @id @default(cuid())
  title       String
  description String?
  category    String
  branchId    String?
  authorId    String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  author      User              @relation("AuthoredResources", fields: [authorId], references: [id])
  branch      Branch?           @relation(fields: [branchId], references: [id])
  territories ResourceTerritory[]
  versions    ResourceVersion[]
}

model ResourceVersion {
  id          String   @id @default(cuid())
  resourceId  String
  version     Int
  fileName    String
  fileKey     String
  fileSize    Int
  uploadedById String
  createdAt   DateTime @default(now())

  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  uploadedBy  User     @relation(fields: [uploadedById], references: [id])

  @@index([resourceId])
}

model ResourceTerritory {
  resourceId  String
  territoryId String
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([resourceId, territoryId])
}

model Report {
  id           String     @id @default(cuid())
  title        String
  description  String?
  category     String
  priority     String     @default("MEDIUM")
  status       String     @default("PENDING")
  latitude     Float?
  longitude    Float?
  address      String?
  photoUrl     String?
  reportedById String
  assignedToId String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  resolvedAt   DateTime?
  assignedTo   User?      @relation("AssignedReports", fields: [assignedToId], references: [id])
  reportedBy   User       @relation("ReportedReports", fields: [reportedById], references: [id])
  territories  ReportTerritory[]

  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@index([assignedToId])
}

model ReportTerritory {
  reportId    String
  territoryId String
  report      Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@id([reportId, territoryId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String
  metadata  Json?
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([userId])
}

model FeatureFlag {
  id        String   @id @default(cuid())
  name      String   @unique
  enabled   Boolean  @default(false)
  rules     Json?    // Targeting rules
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IdempotencyRecord {
  id             String   @id @default(cuid())
  key            String   @unique // The Client-Generated ID/Key
  userId         String
  responseStatus Int
  responseBody   Json
  createdAt      DateTime @default(now())

  @@index([userId, key])
}

model Conflict {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  userId      String
  data        Json
  reason      String
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([entityId])
}

model Invitation {
  id             String    @id @default(cuid())
  email          String
  firstName      String?
  lastName       String?
  tokenHash      String    @unique
  role           String
  branchId       String?
  territoryScope Json?
  expiresAt      DateTime
  usedAt         DateTime?
  revokedAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  invitedBy      User      @relation("InvitedBy", fields: [createdById], references: [id])
}
