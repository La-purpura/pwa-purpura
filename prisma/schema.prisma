generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- M3: Territorios y Ramas ---

model Territory {
  id        String   @id @default(cuid())
  name      String
  type      String   // province, department, locality
  parentId  String?
  parent    Territory? @relation("Hierarchy", fields: [parentId], references: [id])
  children  Territory[] @relation("Hierarchy")
  
  users     User[]
  tasks     Task[]
  projectTerritories ProjectTerritory[]
  requests  Request[]
  posts     Post[]
  resources Resource[]
  incidents Incident[]
}

model Branch {
  id    String @id @default(cuid())
  name  String @unique // PyME, Deportes, Salud...
  users User[]
  posts Post[]
  resources Resource[]
}

// --- M1/M4: Usuarios y Auth ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hash argon2/bcrypt
  name      String?
  role      String   // AdminNacional, Referente, etc.
  status    String   @default("ACTIVE") // ACTIVE, SUSPENDED, PENDING
  
  // Scope
  territoryId String?
  territory   Territory? @relation(fields: [territoryId], references: [id])
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])

  // Relaciones
  assignedTasks Task[]
  requests      Request[]
  ledProjects   Project[]
  auditLogs     AuditLog[] // Relation to audit log
  authoredPosts Post[]     @relation("AuthoredPosts")
  readPosts     PostRead[]
  authoredResources Resource[] @relation("AuthoredResources")
  reportedIncidents Incident[] @relation("ReportedIncidents")
  assignedIncidents Incident[] @relation("AssignedIncidents")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- M5: Tasks ---

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("pending") // pending, in_progress, done
  priority    String   @default("medium")
  dueDate     DateTime?
  
  territoryId String?
  territory   Territory? @relation(fields: [territoryId], references: [id])
  
  assigneeId  String?
  assignee    User?      @relation(fields: [assigneeId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- M6: Alerts ---

model Alert {
  id        String   @id @default(cuid())
  title     String
  type      String   // info, warning, error, news
  message   String
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
}

// --- M7: Projects ---

model Project {
  id          String   @id @default(cuid())
  code        String?  @unique
  title       String
  status      String   @default("draft")
  priority    String   @default("medium")
  type        String?  // Operativo, Institucional...
  branch      String?  // Rama principal (texto o relation opcional)
  description String?
  
  leaderId    String?
  leader      User?    @relation(fields: [leaderId], references: [id])

  territories ProjectTerritory[]
  kpis        ProjectKPI[]
  milestones  ProjectMilestone[]
  risks       ProjectRisk[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectTerritory {
  projectId   String
  project     Project @relation(fields: [projectId], references: [id])
  territoryId String
  territory   Territory @relation(fields: [territoryId], references: [id])

  @@id([projectId, territoryId])
}

model ProjectKPI {
  id        String @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  name      String
  target    Float
  current   Float @default(0)
  unit      String   @default("%")
}

model ProjectMilestone {
  id        String @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  name      String
  status    String   @default("pending")
  endDate   DateTime?
}

model ProjectRisk {
  id          String @id @default(cuid())
  projectId   String
  project     Project @relation(fields: [projectId], references: [id])
  description String
  probability Int
  impact      Int
}

// --- M8: Requests ---

model Request {
  id            String   @id @default(cuid())
  type          String   // Relevamiento, etc.
  data          String // JSON stringified
  status        String   @default("pending")
  feedback      String?
  
  submittedById String
  submittedBy   User     @relation(fields: [submittedById], references: [id])
  
  territoryId   String?
  territory     Territory? @relation(fields: [territoryId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// --- M9: Intranet & Communications ---

model Post {
  id          String   @id @default(cuid())
  title       String
  content     String
  type        String   @default("news") // news, urgent, internal
  
  // Segmentation
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  territoryId String?
  territory   Territory? @relation(fields: [territoryId], references: [id])
  
  authorId    String
  author      User     @relation("AuthoredPosts", fields: [authorId], references: [id])
  
  isDraft     Boolean  @default(false)
  publishedAt DateTime @default(now())
  
  reads       PostRead[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PostRead {
  postId String
  post   Post   @relation(fields: [postId], references: [id])
  userId String
  user   User   @relation(fields: [userId], references: [id])
  
  readAt DateTime @default(now())

  @@id([postId, userId])
}

// --- M10: Resource Library (Documentation) ---

model Resource {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String   // External link or storage ID
  category    String   // Political, Technical, Manual, etc.
  
  // Segmentation
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  territoryId String?
  territory   Territory? @relation(fields: [territoryId], references: [id])
  
  authorId    String
  author      User     @relation("AuthoredResources", fields: [authorId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- M12: Sistema de Incidencias Georeferenciadas ---

model Incident {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   // Infraestructura, Seguridad, Social, Salud, etc.
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED, CLOSED
  
  // Geolocalización
  latitude    Float?
  longitude   Float?
  address     String?
  
  // Evidencia
  photoUrl    String?  // URL externa o base64
  
  // Asignación y seguimiento
  reportedById String
  reportedBy   User    @relation("ReportedIncidents", fields: [reportedById], references: [id])
  
  assignedToId String?
  assignedTo   User?   @relation("AssignedIncidents", fields: [assignedToId], references: [id])
  
  territoryId  String?
  territory    Territory? @relation(fields: [territoryId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?
}

// --- M2: Auditoría ---

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // Ej: TASK_CREATED, USER_LOGIN
  entity    String   // Ej: Task, Project
  entityId  String   // ID del objeto afectado
  actorId   String   // Usuario que hizo la acción
  actor     User     @relation(fields: [actorId], references: [id])
  metadata  String?  // JSON con detalles (Old value -> New value)
  createdAt DateTime @default(now())
}
