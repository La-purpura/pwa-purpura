generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Territory {
  id                 String             @id @default(cuid())
  name               String
  type               String
  parentId           String?
  alerts             Alert[]
  incidents          Incident[]
  posts              Post[]
  projectTerritories ProjectTerritory[]
  requests           Request[]
  resources          Resource[]
  tasks              Task[]
  parent             Territory?         @relation("Hierarchy", fields: [parentId], references: [id])
  children           Territory[]        @relation("Hierarchy")
  users              User[]
}

model Branch {
  id        String     @id @default(cuid())
  name      String     @unique
  posts     Post[]
  resources Resource[]
  users     User[]
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  passwordHash      String
  name              String?
  role              String
  branchId          String?
  territoryScope    Json?
  status            String       @default("ACTIVE")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  territoryId       String?
  auditLogs         AuditLog[]
  assignedIncidents Incident[]   @relation("AssignedIncidents")
  reportedIncidents Incident[]   @relation("ReportedIncidents")
  invitationsSent   Invitation[] @relation("InvitedBy")
  authoredPosts     Post[]       @relation("AuthoredPosts")
  readPosts         PostRead[]
  ledProjects       Project[]
  requests          Request[]
  authoredResources Resource[]   @relation("AuthoredResources")
  sessions          Session[]
  assignedTasks     Task[]
  readAlerts        AlertRead[]
  branch            Branch?      @relation(fields: [branchId], references: [id])
  territory         Territory?   @relation(fields: [territoryId], references: [id])
}

model Session {
  id        String    @id @default(cuid())
  tokenHash String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      String     @default("pending")
  priority    String     @default("medium")
  dueDate     DateTime?
  territoryId String?
  assigneeId  String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  territory   Territory? @relation(fields: [territoryId], references: [id])

  @@index([status])
  @@index([assigneeId])
  @@index([territoryId])
  @@index([createdAt])
}

model Alert {
  id          String      @id @default(cuid())
  title       String
  message     String
  type        String      @default("info")
  severity    String      @default("medium")
  status      String      @default("active")
  territoryId String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  territory   Territory?  @relation(fields: [territoryId], references: [id])
  reads       AlertRead[]

  @@index([status])
  @@index([severity])
  @@index([territoryId])
}

model AlertRead {
  alertId String
  userId  String
  readAt  DateTime @default(now())
  alert   Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([alertId, userId])
}

model Project {
  id          String             @id @default(cuid())
  code        String?            @unique
  title       String
  status      String             @default("draft")
  priority    String             @default("medium")
  type        String?
  branch      String?
  description String?
  leaderId    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  leader      User?              @relation(fields: [leaderId], references: [id])
  kpis        ProjectKPI[]
  milestones  ProjectMilestone[]
  risks       ProjectRisk[]
  territories ProjectTerritory[]
}

model ProjectTerritory {
  projectId   String
  territoryId String
  project     Project   @relation(fields: [projectId], references: [id])
  territory   Territory @relation(fields: [territoryId], references: [id])

  @@id([projectId, territoryId])
}

model ProjectKPI {
  id        String  @id @default(cuid())
  projectId String
  name      String
  target    Float
  current   Float   @default(0)
  unit      String  @default("%")
  project   Project @relation(fields: [projectId], references: [id])
}

model ProjectMilestone {
  id        String    @id @default(cuid())
  projectId String
  name      String
  status    String    @default("pending")
  endDate   DateTime?
  project   Project   @relation(fields: [projectId], references: [id])
}

model ProjectRisk {
  id          String  @id @default(cuid())
  projectId   String
  description String
  probability Int
  impact      Int
  project     Project @relation(fields: [projectId], references: [id])
}

model Request {
  id            String     @id @default(cuid())
  type          String
  data          String
  status        String     @default("pending")
  feedback      String?
  submittedById String
  territoryId   String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  submittedBy   User       @relation(fields: [submittedById], references: [id])
  territory     Territory? @relation(fields: [territoryId], references: [id])
}

model Post {
  id          String     @id @default(cuid())
  title       String
  content     String
  type        String     @default("news")
  branchId    String?
  territoryId String?
  authorId    String
  isDraft     Boolean    @default(false)
  publishedAt DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  author      User       @relation("AuthoredPosts", fields: [authorId], references: [id])
  branch      Branch?    @relation(fields: [branchId], references: [id])
  territory   Territory? @relation(fields: [territoryId], references: [id])
  reads       PostRead[]
}

model PostRead {
  postId String
  userId String
  readAt DateTime @default(now())
  post   Post     @relation(fields: [postId], references: [id])
  user   User     @relation(fields: [userId], references: [id])

  @@id([postId, userId])
}

model Resource {
  id          String     @id @default(cuid())
  title       String
  description String?
  url         String
  category    String
  branchId    String?
  territoryId String?
  authorId    String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  author      User       @relation("AuthoredResources", fields: [authorId], references: [id])
  branch      Branch?    @relation(fields: [branchId], references: [id])
  territory   Territory? @relation(fields: [territoryId], references: [id])
}

model Incident {
  id           String     @id @default(cuid())
  title        String
  description  String?
  category     String
  priority     String     @default("MEDIUM")
  status       String     @default("PENDING")
  latitude     Float?
  longitude    Float?
  address      String?
  photoUrl     String?
  reportedById String
  assignedToId String?
  territoryId  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  resolvedAt   DateTime?
  assignedTo   User?      @relation("AssignedIncidents", fields: [assignedToId], references: [id])
  reportedBy   User       @relation("ReportedIncidents", fields: [reportedById], references: [id])
  territory    Territory? @relation(fields: [territoryId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  actorId   String
  metadata  String?
  createdAt DateTime @default(now())
  actor     User     @relation(fields: [actorId], references: [id])

  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([actorId])
}

model Invitation {
  id             String    @id @default(cuid())
  email          String
  firstName      String?
  lastName       String?
  tokenHash      String    @unique
  role           String
  branchId       String?
  territoryScope Json?
  expiresAt      DateTime
  usedAt         DateTime?
  revokedAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  invitedBy      User      @relation("InvitedBy", fields: [createdById], references: [id])
}
